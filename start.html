<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Survey Redirect</title>
</head>
<body>
  <p>Redirecting... Please wait.</p>

  <script type="module">
    // ‚úÖ Step 1: Import Supabase
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ‚úÖ Step 2: Add your Supabase project credentials here
    const supabaseUrl = "https://qbezfrqsojypxpmyblbc.supabase.co";  // üîÅ Replace this
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZXpmcnFzb2p5cHhwbXlibGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjIxNDgsImV4cCI6MjA1OTU5ODE0OH0.FwfbMTlfPQ17OpoMXR3zDL13lwHwm3QlblV5dmHfEVc";                        // üîÅ Replace this
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ‚úÖ Step 3: Extract query params
    const urlParams = new URLSearchParams(window.location.search);
    const sid = urlParams.get('sid');
    const projectId = urlParams.get('project_id');
    const surveyId = urlParams.get('survey_id');

    if (!sid || !projectId || !surveyId) {
      document.body.innerHTML = '<p>Missing or invalid parameters.</p>';
      throw new Error("Missing parameters");
    }

    // ‚úÖ Step 4: Fetch redirect info from Supabase
    async function handleRedirect() {
      try {
        // Log the visit
        await supabase.from('redirect_logs').insert([
          {
            sid: sid,
            project_id: projectId,
            survey_id: surveyId,
            status: 'started',
            timestamp: new Date().toISOString(),
          }
        ]);

        // Fetch redirect link
        const { data, error } = await supabase
          .from('redirect_links')
          .select('*')
          .eq('sid', sid)
          .eq('project_id', projectId)
          .eq('survey_id', surveyId)
          .single();

        if (error || !data) {
          document.body.innerHTML = '<p>System error. Please contact <a href="mailto:support@kphotone.com">support@kphotone.com</a>.</p>';
          return;
        }

        // Redirect to the supplier‚Äôs actual survey URL
        window.location.href = data.survey_url;
      } catch (err) {
        console.error(err);
        document.body.innerHTML = '<p>Unexpected error. Please contact <a href="mailto:support@kphotone.com">support@kphotone.com</a>.</p>';
      }
    }

    handleRedirect();
  </script>
</body>
</html>
