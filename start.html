<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Redirecting...</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://qbezfrqsojypxpmyblbc.supabase.co'; // your Supabase URL
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZXpmcnFzb2p5cHhwbXlibGJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMjIxNDgsImV4cCI6MjA1OTU5ODE0OH0.FwfbMTlfPQ17OpoMXR3zDL13lwHwm3QlblV5dmHfEVc'; // replace with your actual anon key
    const supabase = createClient(supabaseUrl, supabaseKey);

    const urlParams = new URLSearchParams(window.location.search);
    const sid = urlParams.get('sid');
    const project_id = urlParams.get('project_id');
    const survey_id = urlParams.get('survey_id');

    async function redirectToSurvey() {
      if (!sid || !project_id || !survey_id) {
        document.body.innerText = 'Missing or invalid parameters.';
        return;
      }

      try {
        const { data, error } = await supabase
          .from('redirect_links')
          .select('actual_link')
          .eq('sid', sid)
          .eq('project_id', project_id)
          .eq('survey_id', survey_id)
          .single();

        if (error || !data || !data.actual_link) {
          console.error(error);
          document.body.innerText = 'System error. Please contact support@kphotone.com.';
          return;
        }

        window.location.href = data.actual_link;
      } catch (e) {
        console.error(e);
        document.body.innerText = 'Unexpected error. Please contact support@kphotone.com.';
      }
    }

    redirectToSurvey();
  </script>
</head>
<body>
  <p>Redirecting you to the surveyâ€¦</p>
</body>
</html>
